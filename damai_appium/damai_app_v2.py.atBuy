# -*- coding: UTF-8 -*-
"""
__Author__ = "BlueCestbon"
__Version__ = "2.3.0"
__Description__ = "å¤§éº¦appæŠ¢ç¥¨è‡ªåŠ¨åŒ– - ä¼˜åŒ–ç‰ˆ"
"""

import time
from appium import webdriver
from appium.options.common.base import AppiumOptions
from appium.webdriver.common.appiumby import AppiumBy
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.common.exceptions import TimeoutException, NoSuchElementException

from config import Config


class DamaiBot:
    def __init__(self):
        self.config = Config.load_config()
        self.driver = None
        self.wait = None
        self._setup_driver()

    def _setup_driver(self):
        """åˆå§‹åŒ–é©±åŠ¨é…ç½®"""
        capabilities = {
            "platformName": "Android",
            "platformVersion": "15",
            "deviceName": "OnePlus 11",
            "appPackage": "cn.damai",
            "appActivity": ".launcher.splash.SplashMainActivity",
            "unicodeKeyboard": True,
            "resetKeyboard": True,
            "noReset": True,
            "newCommandTimeout": 6000,
            "automationName": "UiAutomator2",
            "skipServerInstallation": False,
            "ignoreHiddenApiPolicyError": True,
            "disableWindowAnimation": True,
            "shouldTerminateApp": False,
            "adbExecTimeout": 20000,
        }

        device_app_info = AppiumOptions()
        device_app_info.load_capabilities(capabilities)
        self.driver = webdriver.Remote(self.config.server_url, options=device_app_info)

        # ä¼˜åŒ–çš„è®¾ç½®
        self.driver.update_settings({
            "waitForIdleTimeout": 300,
            "actionAcknowledgmentTimeout": 50,
            "keyInjectionDelay": 0,
            "waitForSelectorTimeout": 500,
            "ignoreUnimportantViews": True,
            "allowInvisibleElements": False,
        })

        self.driver.implicitly_wait(2)
        self.wait = WebDriverWait(self.driver, 3)

    def safe_click(self, element):
        """å®‰å…¨ç‚¹å‡»å…ƒç´ """
        try:
            rect = element.rect
            x = rect['x'] + rect['width'] // 2
            y = rect['y'] + rect['height'] // 2
            self.driver.execute_script("mobile: clickGesture", {
                "x": x, "y": y, "duration": 30
            })
        except:
            element.click()

    def quick_screenshot(self, name="debug"):
        """å¿«é€Ÿæˆªå›¾ï¼ˆä»…åœ¨å¤±è´¥æ—¶ä½¿ç”¨ï¼‰"""
        try:
            self.driver.save_screenshot(f"{name}.png")
            print(f"  å·²ä¿å­˜æˆªå›¾: {name}.png")
        except:
            pass

    def search_and_select_event(self):
        """æœç´¢å¹¶é€‰æ‹©æ¼”å‡º - å¼ºåŒ–ç‰ˆ"""
        print("\næ­¥éª¤1: æœç´¢æ¼”å‡º...")
        
        # ç­‰å¾…é¦–é¡µåŠ è½½
        time.sleep(2)
        
        # æ–¹æ¡ˆ1: ç‚¹å‡»æœç´¢ViewGroupï¼ˆæœ€ç›´æ¥ï¼‰
        try:
            search_area = self.driver.find_element(
                By.ID, "cn.damai:id/homepage_header_search"
            )
            self.safe_click(search_area)
            print("  âœ“ ç‚¹å‡»æœç´¢åŒºåŸŸ")
            time.sleep(0.5)
        except:
            # æ–¹æ¡ˆ2: ç‚¹å‡»æœç´¢æŒ‰é’®
            try:
                search_btn = self.driver.find_element(
                    By.ID, "cn.damai:id/homepage_header_search_btn"
                )
                self.safe_click(search_btn)
                print("  âœ“ ç‚¹å‡»æœç´¢æŒ‰é’®")
                time.sleep(0.5)
            except:
                print("  âœ— æ— æ³•æ‰“å¼€æœç´¢")
                self.quick_screenshot("search_failed")
                return False
        
        # æŸ¥æ‰¾è¾“å…¥æ¡†å¹¶è¾“å…¥
        input_found = False
        input_box = None
        input_selectors = [
            (By.CLASS_NAME, "android.widget.EditText"),
            (AppiumBy.ANDROID_UIAUTOMATOR, 'new UiSelector().className("android.widget.EditText")'),
        ]
        
        for by, value in input_selectors:
            try:
                input_box = WebDriverWait(self.driver, 2).until(
                    EC.presence_of_element_located((by, value))
                )
                input_box.clear()
                input_box.send_keys(self.config.keyword)
                print(f"  âœ“ è¾“å…¥å…³é”®è¯: {self.config.keyword}")
                input_found = True
                break
            except:
                continue
        
        if not input_found:
            print("  âœ— æœªæ‰¾åˆ°è¾“å…¥æ¡†")
            self.quick_screenshot("input_not_found")
            return False
        
        # ã€å…³é”®ä¿®å¤ã€‘ç›´æ¥æŒ‰Enteré”®è§¦å‘æœç´¢ï¼Œé¿å…ç©ºæ ¼é—®é¢˜
        print("  æŒ‰Enterè§¦å‘æœç´¢...")
        try:
            self.driver.press_keycode(66)  # Android keycode 66 = ENTER
            time.sleep(1.5)
            print("  âœ“ å·²è§¦å‘æœç´¢")
        except Exception as e:
            print(f"  âš  Enteré”®å¤±è´¥: {e}")
            time.sleep(1.5)
        
        # ã€æ–¹å¼1ã€‘å°è¯•ç‚¹å‡»æœç´¢ç»“æœåˆ—è¡¨ä¸­çš„ç¬¬ä¸€é¡¹ï¼ˆæœ€å¸¸è§ï¼‰
        print("  æŸ¥æ‰¾æœç´¢ç»“æœ...")
        try:
            # ç­‰å¾…æœç´¢ç»“æœåŠ è½½
            time.sleep(1)
            
            # æŸ¥æ‰¾RecyclerViewï¼ˆæœç´¢ç»“æœé€šå¸¸åœ¨è¿™é‡Œï¼‰
            result_list = self.driver.find_element(
                By.CLASS_NAME, "androidx.recyclerview.widget.RecyclerView"
            )
            
            # è·å–ç¬¬ä¸€ä¸ªå¯ç‚¹å‡»çš„å­å…ƒç´ 
            first_result = result_list.find_element(
                AppiumBy.ANDROID_UIAUTOMATOR,
                'new UiSelector().clickable(true).index(0)'
            )
            
            self.safe_click(first_result)
            print("  âœ“ ç‚¹å‡»ç¬¬ä¸€ä¸ªæœç´¢ç»“æœ")
            time.sleep(1.5)
            return True
            
        except Exception as e:
            print(f"  âš  æ–¹å¼1å¤±è´¥: {e}")
        
        # ã€æ–¹å¼2ã€‘é€šè¿‡åæ ‡ç‚¹å‡»ï¼ˆå‡è®¾æœç´¢ç»“æœåœ¨å±å¹•ä¸ŠåŠéƒ¨åˆ†ï¼‰
        print("  å°è¯•é€šè¿‡åæ ‡ç‚¹å‡»...")
        try:
            # è·å–å±å¹•å°ºå¯¸
            size = self.driver.get_window_size()
            width = size['width']
            height = size['height']
            
            # ç‚¹å‡»å±å¹•ä¸Šéƒ¨ä¸­é—´ä½ç½®ï¼ˆé€šå¸¸æ˜¯ç¬¬ä¸€ä¸ªæœç´¢ç»“æœï¼‰
            x = width // 2
            y = height // 4
            
            self.driver.execute_script("mobile: clickGesture", {
                "x": x, "y": y, "duration": 50
            })
            print(f"  âœ“ åæ ‡ç‚¹å‡»: ({x}, {y})")
            time.sleep(1.5)
            return True
            
        except Exception as e:
            print(f"  âš  æ–¹å¼2å¤±è´¥: {e}")
        
        # ã€æ–¹å¼3ã€‘æŸ¥æ‰¾ä»»æ„å¯ç‚¹å‡»çš„TextViewï¼ˆå®½æ¾åŒ¹é…ï¼‰
        print("  å°è¯•æŸ¥æ‰¾å¯ç‚¹å‡»TextView...")
        try:
            textviews = self.driver.find_elements(
                AppiumBy.ANDROID_UIAUTOMATOR,
                'new UiSelector().className("android.widget.TextView").clickable(true)'
            )
            
            # ç‚¹å‡»ç¬¬ä¸€ä¸ªéç©ºæ–‡æœ¬çš„TextView
            for tv in textviews[:5]:  # åªæ£€æŸ¥å‰5ä¸ª
                text = tv.text
                if text and len(text) > 0:
                    self.safe_click(tv)
                    print(f"  âœ“ ç‚¹å‡»TextView: {text}")
                    time.sleep(1.5)
                    return True
                    
        except Exception as e:
            print(f"  âš  æ–¹å¼3å¤±è´¥: {e}")
        
        print("  âœ— æ‰€æœ‰æ–¹å¼å‡å¤±è´¥")
        self.quick_screenshot("select_event_failed")
        return False

    def select_city_and_date(self):
        """é€‰æ‹©åŸå¸‚å’Œæ—¥æœŸ - ç®€åŒ–ç‰ˆ"""
        print("\næ­¥éª¤2: é€‰æ‹©åŸå¸‚å’Œæ—¥æœŸ...")
        
        # å°è¯•ç›´æ¥ç‚¹å‡»åŸå¸‚
        try:
            city_el = WebDriverWait(self.driver, 2).until(
                EC.presence_of_element_located((
                    AppiumBy.ANDROID_UIAUTOMATOR,
                    f'new UiSelector().textContains("{self.config.city}")'
                ))
            )
            self.safe_click(city_el)
            print(f"  âœ“ é€‰æ‹©åŸå¸‚: {self.config.city}")
            time.sleep(0.5)
        except:
            # å°è¯•æ»šåŠ¨æŸ¥æ‰¾
            for _ in range(2):
                try:
                    city_el = self.driver.find_element(
                        AppiumBy.ANDROID_UIAUTOMATOR,
                        f'new UiSelector().textContains("{self.config.city}")'
                    )
                    self.safe_click(city_el)
                    print(f"  âœ“ æ»šåŠ¨åé€‰æ‹©åŸå¸‚: {self.config.city}")
                    time.sleep(0.5)
                    break
                except:
                    self.driver.execute_script('mobile: scrollGesture', {
                        'left': 100, 'top': 500, 'width': 800, 'height': 1500,
                        'direction': 'down', 'percent': 0.5
                    })
                    time.sleep(0.3)
            else:
                print(f"  âš  æœªæ‰¾åˆ°åŸå¸‚ï¼Œç»§ç»­")
        
        # æ—¥æœŸé€‰æ‹©ï¼ˆå¯é€‰ï¼‰
        if self.config.date:
            try:
                date_el = self.driver.find_element(
                    AppiumBy.ANDROID_UIAUTOMATOR,
                    f'new UiSelector().textContains("{self.config.date}")'
                )
                self.safe_click(date_el)
                print(f"  âœ“ é€‰æ‹©æ—¥æœŸ: {self.config.date}")
                time.sleep(0.5)
            except:
                print(f"  âš  æœªæ‰¾åˆ°æ—¥æœŸï¼Œè·³è¿‡")
        
        return True

    def click_buy_button(self):
        """ç‚¹å‡»è´­ä¹°æŒ‰é’®"""
        print("\næ­¥éª¤3: ç‚¹å‡»è´­ä¹°...")
        
        buy_ids = [
            "cn.damai:id/trade_project_detail_purchase_status_bar_container_fl",
            "cn.damai:id/btn_buy",
        ]
        
        # å…ˆå°è¯•ID
        for buy_id in buy_ids:
            try:
                btn = WebDriverWait(self.driver, 2).until(
                    EC.presence_of_element_located((By.ID, buy_id))
                )
                self.safe_click(btn)
                print("  âœ“ è´­ä¹°æŒ‰é’®å·²ç‚¹å‡»")
                time.sleep(1)
                return True
            except:
                continue
        
        # å†å°è¯•æ–‡æœ¬
        try:
            btn = self.driver.find_element(
                AppiumBy.ANDROID_UIAUTOMATOR,
                'new UiSelector().textMatches(".*é¢„çº¦.*|.*è´­ä¹°.*|.*ç«‹å³.*")'
            )
            self.safe_click(btn)
            print("  âœ“ è´­ä¹°æŒ‰é’®å·²ç‚¹å‡»")
            time.sleep(1)
            return True
        except:
            print("  âœ— æœªæ‰¾åˆ°è´­ä¹°æŒ‰é’®")
            self.quick_screenshot("buy_button_not_found")
            return False

    def select_price(self):
        """é€‰æ‹©ç¥¨ä»·"""
        print("\næ­¥éª¤4: é€‰æ‹©ç¥¨ä»·...")
        
        try:
            price_container = WebDriverWait(self.driver, 3).until(
                EC.presence_of_element_located((
                    By.ID, 'cn.damai:id/project_detail_perform_price_flowlayout'
                ))
            )
            time.sleep(0.3)
            
            target_price = price_container.find_element(
                AppiumBy.ANDROID_UIAUTOMATOR,
                f'new UiSelector().className("android.widget.FrameLayout").index({self.config.price_index})'
            )
            self.safe_click(target_price)
            print(f"  âœ“ ç¥¨ä»·å·²é€‰æ‹© (index: {self.config.price_index})")
            time.sleep(0.3)
            return True
        except:
            print(f"  âœ— ç¥¨ä»·é€‰æ‹©å¤±è´¥")
            self.quick_screenshot("price_selection_failed")
            return False

    def select_quantity(self):
        """é€‰æ‹©æ•°é‡"""
        print("\næ­¥éª¤5: é€‰æ‹©æ•°é‡...")
        
        clicks_needed = len(self.config.users) - 1
        if clicks_needed <= 0:
            print(f"  âš  åªéœ€1å¼ ç¥¨ï¼Œè·³è¿‡")
            return True
        
        try:
            plus_button = self.driver.find_element(By.ID, 'img_jia')
            for _ in range(clicks_needed):
                self.safe_click(plus_button)
                time.sleep(0.05)
            print(f"  âœ“ æ•°é‡: {len(self.config.users)}")
            return True
        except:
            print(f"  âš  æœªæ‰¾åˆ°æ•°é‡é€‰æ‹©å™¨")
            return True  # ä¸å½±å“æµç¨‹

    def confirm_purchase(self):
        """ç¡®è®¤è´­ä¹°"""
        print("\næ­¥éª¤6: ç¡®è®¤è´­ä¹°...")
        
        try:
            confirm_btn = WebDriverWait(self.driver, 2).until(
                EC.presence_of_element_located((By.ID, "btn_buy_view"))
            )
            self.safe_click(confirm_btn)
            print("  âœ“ ç¡®è®¤æŒ‰é’®å·²ç‚¹å‡»")
            time.sleep(0.8)
            return True
        except:
            # å°è¯•æ–‡æœ¬æŸ¥æ‰¾
            try:
                confirm_btn = self.driver.find_element(
                    AppiumBy.ANDROID_UIAUTOMATOR,
                    'new UiSelector().textMatches(".*ç¡®å®š.*|.*è´­ä¹°.*")'
                )
                self.safe_click(confirm_btn)
                print("  âœ“ ç¡®è®¤æŒ‰é’®å·²ç‚¹å‡»")
                time.sleep(0.8)
                return True
            except:
                print("  âœ— æœªæ‰¾åˆ°ç¡®è®¤æŒ‰é’®")
                return False

    def select_users(self):
        """é€‰æ‹©è´­ç¥¨äºº"""
        print("\næ­¥éª¤7: é€‰æ‹©è´­ç¥¨äºº...")
        
        success = False
        for i, user in enumerate(self.config.users):
            try:
                user_el = WebDriverWait(self.driver, 1.5).until(
                    EC.presence_of_element_located((
                        AppiumBy.ANDROID_UIAUTOMATOR,
                        f'new UiSelector().textContains("{user}")'
                    ))
                )
                self.safe_click(user_el)
                print(f"  âœ“ å·²é€‰æ‹©: {user}")
                success = True
                time.sleep(0.1)
            except:
                print(f"  âœ— æœªæ‰¾åˆ°ç”¨æˆ·: {user}")
        
        return success

    def submit_order(self):
        """æäº¤è®¢å•"""
        print("\næ­¥éª¤8: æäº¤è®¢å•...")
        
        if not self.config.if_commit_order:
            print("  âš  é…ç½®ä¸ºä¸æäº¤ï¼Œè·³è¿‡")
            return True
        
        try:
            submit_btn = WebDriverWait(self.driver, 2).until(
                EC.presence_of_element_located((
                    AppiumBy.ANDROID_UIAUTOMATOR,
                    'new UiSelector().text("ç«‹å³æäº¤")'
                ))
            )
            self.safe_click(submit_btn)
            print("  âœ“ è®¢å•å·²æäº¤")
            return True
        except:
            print("  âœ— æäº¤å¤±è´¥")
            self.quick_screenshot("submit_failed")
            return False

    def run_ticket_grabbing(self):
        """æ‰§è¡ŒæŠ¢ç¥¨æµç¨‹"""
        try:
            print("\n" + "="*60)
            print("å¼€å§‹æŠ¢ç¥¨æµç¨‹")
            print("="*60)
            start_time = time.time()

            steps = [
                ("æœç´¢æ¼”å‡º", self.search_and_select_event),
                ("é€‰æ‹©åŸå¸‚æ—¥æœŸ", self.select_city_and_date),
                ("ç‚¹å‡»è´­ä¹°", self.click_buy_button),
                ("é€‰æ‹©ç¥¨ä»·", self.select_price),
                ("é€‰æ‹©æ•°é‡", self.select_quantity),
                ("ç¡®è®¤è´­ä¹°", self.confirm_purchase),
                ("é€‰æ‹©ç”¨æˆ·", self.select_users),
                ("æäº¤è®¢å•", self.submit_order),
            ]

            for step_name, step_func in steps:
                if not step_func():
                    print(f"\nâœ— å¤±è´¥äº: {step_name}")
                    return False

            elapsed = time.time() - start_time
            print("\n" + "="*60)
            print(f"âœ“ æµç¨‹å®Œæˆï¼è€—æ—¶: {elapsed:.1f}ç§’")
            print("="*60)
            return True

        except Exception as e:
            print(f"\nâœ— å¼‚å¸¸: {e}")
            self.quick_screenshot("exception")
            return False

    def run_with_retry(self, max_retries=3):
        """å¸¦é‡è¯•çš„æŠ¢ç¥¨"""
        for attempt in range(max_retries):
            print(f"\n{'='*60}")
            print(f"ç¬¬ {attempt + 1}/{max_retries} æ¬¡å°è¯•")
            print(f"{'='*60}")
            
            try:
                if self.run_ticket_grabbing():
                    print("\nğŸ‰ æŠ¢ç¥¨æˆåŠŸï¼")
                    return True
            except Exception as e:
                print(f"\nç¬¬ {attempt + 1} æ¬¡å¼‚å¸¸: {e}")
            
            if attempt < max_retries - 1:
                print(f"\nç­‰å¾…2ç§’åé‡è¯•...")
                time.sleep(2)
                try:
                    self.driver.quit()
                except:
                    pass
                self._setup_driver()

        print("\nâŒ æ‰€æœ‰å°è¯•å¤±è´¥")
        try:
            self.driver.quit()
        except:
            pass
        return False


if __name__ == "__main__":
    bot = DamaiBot()
    bot.run_with_retry(max_retries=3)
